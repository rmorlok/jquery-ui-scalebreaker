// Generated by CoffeeScript 1.3.3
(function() {

  (function($) {
    return $.widget("salsita.scalebreaker", {
      options: {
        scaleDialog: true,
        cssAnimated: true,
        dialogContent: '',
        idNamespace: 'jq-scalebreaker',
        dialogPosition: 'bottom',
        closeOnBackdrop: true,
        denyUserScroll: true,
        debug: false
      },
      _create: function() {
        this.rawElement = "<div id='" + this.options.idNamespace + "'><div id='" + this.options.idNamespace + "-dialog'></div></div>";
        this.backdrop = null;
        this.dialog = null;
        this.scaleFactor = null;
        this.initialViewport = [];
        this.currentViewportOffset = [];
        return this._initWidget();
      },
      _initWidget: function() {
        $('body').append(this.rawElement);
        this.backdrop = $('#' + this.options.idNamespace);
        this.dialog = this.backdrop.find('#' + this.options.idNamespace + '-dialog');
        this._logMessage('wrapper reference created', this.backdrop);
        this._getInitialViewport();
        this._getScaleFactor();
        return this.addContentToDialog(this.options.dialogContent);
      },
      _triggerEvent: function(name, data) {
        this.element.trigger(name, [data]);
        return this._logMessage(name, data);
      },
      _logMessage: function(name, args) {
        if (this.options.debug) {
          return console.debug("" + this.options.idNamespace + ": " + name, args);
        }
      },
      _getScaleFactor: function() {
        this.scaleFactor = window.innerWidth / document.documentElement.clientWidth;
        this._logMessage('scale factor found', this.scaleFactor);
        return this.scaleFactor;
      },
      _getInitialViewport: function() {
        this.initialViewport = [window.innerWidth, window.innerHeight];
        this._logMessage('initial viewport', this.initialViewport);
        return this.initialViewport;
      },
      _getCurrentViewportOffset: function() {
        this.currentViewportOffset = [window.pageXOffset, window.pageYOffset];
        this._logMessage('current viewport offset', this.currentViewportOffset);
        return this.currentViewportOffset;
      },
      addContentToDialog: function(content) {
        this.dialog.html(content);
        return this._logMessage('adding content to dialog', content);
      },
      rescaleAndReposition: function(el) {
        var newViewport, oldViewport, _self;
        _self = this;
        oldViewport = this.initialViewport;
        newViewport = this._getCurrentViewportOffset();
        if (this.options.dialogPosition === 'top') {
          el.css({
            'top': newViewport[1],
            'left': 0,
            'transform-origin': '0 0',
            '-webkit-transform-origin': '0 0'
          });
        }
        if (this.options.dialogPosition === 'bottom') {
          el.css({
            'bottom': oldViewport[1] - (newViewport[1] + window.innerHeight),
            'left': 0,
            'transform-origin': '0 100%',
            '-webkit-transform-origin': '0 100%'
          });
        }
        return el.css({
          'transform': "scale(" + (_self._getScaleFactor()) + ")",
          '-webkit-transform': "scale(" + (_self._getScaleFactor()) + ")"
        });
      },
      show: function() {
        var _self;
        _self = this;
        if (this.options.closeOnBackdrop) {
          _self.backdrop.on("click." + this.options.idNamespace, function(e) {
            if (e.target === _self.backdrop.get(0)) {
              return _self.hide();
            }
          });
        }
        if (this.options.denyUserScroll) {
          $('body').on("touchmove." + this.options.idNamespace, function(e) {
            return e.preventDefault();
          });
        }
        if (this.options.scaleDialog) {
          this.rescaleAndReposition(this.dialog);
        }
        this.backdrop.addClass("" + this.options.idNamespace + "-show");
        if (this.options.cssAnimated) {
          this.backdrop.addClass("" + this.options.idNamespace + "-animate-in");
          this.backdrop.one('animationend webkitAnimationEnd', function(e) {
            return _self.backdrop.removeClass("" + _self.options.idNamespace + "-animate-in");
          });
        }
        return this._logMessage('showing widget');
      },
      hide: function() {
        var _self;
        _self = this;
        if (this.options.denyUserScroll) {
          $('body').off("touchmove." + this.options.idNamespace);
        }
        if (this.options.closeOnBackdrop && this.options.cssAnimated) {
          _self.backdrop.off("click." + this.options.idNamespace);
          this.backdrop.addClass("" + this.options.idNamespace + "-animate-out");
          this.backdrop.one('animationend webkitAnimationEnd', function(e) {
            _self.backdrop.removeClass("" + _self.options.idNamespace + "-animate-out");
            _self.backdrop.removeClass("" + _self.options.idNamespace + "-show");
            if (_self.options.scaleDialog) {
              return _self.dialog.removeAttr('style');
            }
          });
        } else if (this.options.closeOnBackdrop) {
          _self.backdrop.off("click." + this.options.idNamespace);
          this.backdrop.removeClass("" + this.options.idNamespace + "-show");
          if (this.options.scaleDialog) {
            this.dialog.removeAttr('style');
          }
        }
        return this._logMessage('hiding widget');
      },
      destroy: function() {
        this.backdrop.remove();
        this.rawElement = null;
        this.backdrop = null;
        this.dialog = null;
        this.scaleFactor = null;
        this.initialViewport = null;
        this.currentViewportOffset = null;
        return this._destroy();
      },
      _destroy: $.noop
    });
  })(jQuery);

}).call(this);
